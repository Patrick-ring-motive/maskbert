<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>DistilBERT Masked Fill - Pure TF.js</title>
</head>
<body>
  <h1>DistilBERT Masked Fill (TF.js WebGL)</h1>
  <input id="text" size="60" value="The capital of France is [MASK]." />
  <button onclick="run()">Predict</button>
  <pre id="output">Loading...</pre>

  <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.10.0"></script>
  <script>
    async function fetchText(){
      return await(await fetch(...arguments)).text();
    }

    const getVocab = async()=>{
      let text = String(await fetchText('vocab.txt')).split('\n');
      text = `${text}\n${text.toLowerCase()}`;
      return [...new Set(text.split('\n').map(x=>x.trim()).filter(x=>x))];
    };
    
    let model;
    const maskToken = '[MASK]';
    const maskId = 103; // BERT base uncased and DistilBERT use 103 for [MASK]

    // Minimal vocab
    const vocab = await getVocab();
    const invVocab = Object.fromEntries(Object.entries(vocab).map(([k, v]) => [v, k]));

    function tokenize(text) {
      return ["[CLS]", ...text.toLowerCase().replaceAll('.', ' .').split(/\s+/), "[SEP]"]
        .map(token => vocab[token] ?? 100); // 100 = [UNK]
    }

    async function loadModel() {
      tf.setBackend('webgl');
      await tf.ready();
      model = await tf.loadGraphModel('./distilbert-tfjs/model.json');
      document.getElementById('output').textContent = 'Model loaded.';
    }

    async function run() {
      const text = document.getElementById('text').value;
      const inputIdsArray = tokenize(text);
      console.log({inputIdsArray});
      const inputIds = tf.tensor([inputIdsArray], undefined, 'int32');
      const attentionMask = tf.tensor([inputIdsArray.map(() => 1)], undefined, 'int32');

      const result = await model.executeAsync({
        'input_ids': inputIds,
        'attention_mask': attentionMask
      });
      const resultArray = result.arraySync();
      console.log({resultArray});
      const logits = resultArray[0]; // [seq_len, vocab_size]
      const maskIndex = inputIdsArray.indexOf(maskId);
      let maskLogits = logits[maskIndex]; 
      if(!maskLogits){
        console.log(`${maskIndex} not found`);
        maskLogits = logits[0];// fallback if not found
      }

      const top5 = [...maskLogits.map((score, id) => ({ id, score }))]
        .sort((a, b) => b.score - a.score).filter(({ id })=>invVocab[id]).slice(0,5)
        .map(({ id, score }) => `${invVocab[id] ?? '[UNK]'} (${score.toFixed(3)})`)
        .join('\n');

      document.getElementById('output').textContent = top5;
    }

    loadModel();
  </script>
</body>
</html>
